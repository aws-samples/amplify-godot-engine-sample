version: 1
backend:
    phases:
        preBuild:
            commands:
                - echo "Setup Game Backend..."  
                - echo "Setup Game Server..."  
        build:
            commands:
                - echo "Build Game Backend..."  
                - npm ci --cache .npm --prefer-offline
                - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
                - npx ampx generate outputs --branch $AWS_BRANCH --app-id $AWS_APP_ID --out-dir ./website/src
                - echo "Build Game Server..."  
frontend:
    phases:
        preBuild:
            commands:
                # Web Site
                - echo "Setup Web Site..."  
                - cd website   
                - npm install
                - cd ..

                # Game Client
                - echo "Setup Game Client..."
                - cd game-client
                - cd ..   
        build:
            commands:
                # Web Site
                - echo "Build Web Site..."
                - cd website   
                - npm run build
                - cd ..     

                # Game Client (Web)
                - echo "Export Game Client (Web)..."
                - cd game-client
                - mkdir build
                - godot --headless --verbose --export-release "Web"
                - mv build/* ../website/build/game
                - cd ..

                #
                #- 'mkdir -v -p build/mac && cd game/client && godot --headless --verbose --export-release "macOS"'
                #- 'ls ../../'
                #- 'ls ../../build/mac'
    artifacts:
        #baseDirectory: /build/mac/
        #files:
        #    - '**/*'
        baseDirectory: website/build
        files:
            - '**/*'  
    cache:
        paths:
            - website/node_modules/