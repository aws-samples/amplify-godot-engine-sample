version: 1
backend:
    phases:
        preBuild:
            commands:
                - node --version
                - echo "Setup Game Backend..."  
                - echo "Setup Game Server..."
        build:
            commands:
                - echo "Build Game Backend..."  
                - npm ci --cache .npm --prefer-offline
                - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
                - npx ampx generate outputs --branch $AWS_BRANCH --app-id $AWS_APP_ID --out-dir ./website/src
                - npx ampx generate outputs --branch $AWS_BRANCH --app-id $AWS_APP_ID --out-dir ./game-client
                - echo "Build Game Server..."  
frontend:
    phases:
        preBuild:
            commands:
                - node --version
                # Web Site
                - echo "Setup Web Site..."  
                - cd website   
                - npm install
                - cd ..
        build:
            commands:
                # Web Site
                - echo "Build Web Site..."
                - cd website   
                - npm run build
                - cd ..     

                # Game Client (Web)
                - echo "Export Game Client (Web)..."
                - cd game-client
                - mkdir build
                - godot --headless --verbose --export-release "Web"
                - mv build/* ../website/build/game
                - cd ..

                # Game Client (macOS)
                - echo "Setup Game Client..."
                - echo "Build Game Client (macOS)..." 
                - cd game-client
                - mkdir -v -p build-mac
                - godot --headless --verbose --export-release "macOS"
                - cd ..
                - echo "Deploy game builds to S3..."
                - bucket_name=$(jq -r '.storage.bucket_name' amplify_outputs.json)
                - echo $bucket_name
                - aws s3 cp game-client/build-mac/squash_the_creeps_macos.zip s3://$bucket_name/releases/squash_the_creeps_macos.zip

                # Game Client (Windows Desktop)
                - echo "Build Game Client (Windows Desktop)..." 
                - cd game-client
                - mkdir -v -p build-windows
                - godot --headless --verbose --export-release "Windows Desktop"
                - cd ..
                - echo "Deploy game builds to S3..."
                - aws s3 cp game-client/build-windows/squash_the_creeps_windows.zip s3://$bucket_name/releases/squash_the_creeps_windows.zip

                # Game Client (Android)
                - echo "Build Game Client (Android)..."
                - cd game-client
                - mkdir -v -p build-android
                - godot --headless --verbose --export-debug "Android"
                - cd ..
                - echo "Deploy game builds to S3..."
                - aws s3 cp game-client/build-android/squash_the_creeps_android.zip s3://$bucket_name/releases/squash_the_creeps_android.zip

    artifacts:
        #baseDirectory: /build/mac/
        #files:
        #    - '**/*'
        baseDirectory: website/build
        files:
            - '**/*'  
    cache:
        paths:
            - website/node_modules/